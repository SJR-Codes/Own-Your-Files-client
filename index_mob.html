<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="favicon.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#4a4a4a">
<link rel="manifest" href="manifest.webmanifest">
<title>Own Your Files â€“ Client</title>
<style>
* { box-sizing: border-box; }
body {
    background-color: #b0aabb;
    margin: 0 auto;
    max-width: 50em;
    font-family: "Helvetica", "Arial", sans-serif;
    font-size: calc(15px + 0.390625vw); /* responsive font size */
    text-align: center;
    min-height: 100vh;
}
h1, h2, h3 { margin: 0; }
.oyf-head, .oyf-foot {color: antiquewhite; height: 3.7em;}
.oyf-content { 
    background-image: linear-gradient(to bottom, #848386, #a09ea5); 
    padding: 0.5em 0;
    min-height: 75vh;
}
.oyf-head {
    background-image: linear-gradient(to bottom, #39383b, #848386);
    border-radius: 5em 5em 0 0;
    overflow: hidden;
}
.oyf-head::after {
    content: "";
    display: table;
    clear: both;
    border-bottom: #24202e 2px;
}
.oyf-foot {
    background-image: linear-gradient(to bottom,#848386, #39383b);
    border-radius: 0 0 1.5em 1.5em;
}
.oyf-foot p {margin: 0;padding: 1em 0;}
.oyf-foot a, .oyf-foot .fakelink {color: antiquewhite;}
.oyf-foot .fakelink:hover { color: #24202e; font-weight: bold; cursor: pointer;}
.text-input {
    max-width: 20em;
    border-radius: 4em;
    font-size: 1rem;
    background-color: #b0b5b3;
    padding: 1em 1em;
    margin: 0.5em 0;
    border: none;
}
.text-input::placeholder {color: #6b6969;}
.hidden {display: none;}
.button {
    background-color: #858a88;
    border: 1px solid #2d2b2b;
    border-radius: 4em;
    font-size: 2rem;
    font-weight: bold;
    color: #262525;
    padding: 0.5em 0.8em;
    cursor: pointer;
}
.thumb {padding: 0.5em 0.5em;cursor: pointer;}
.midpic img {cursor: pointer;width: 100%;}
.error, .success {border-radius: 4em; margin-top: 1em; padding: 0.5em 0.5em;}
.error{background-color: #a3182b;}
.success{background-color: #238860;}
</style>
</head>
<body>
<div class="oyf-head">
    <h1>Own Your Files</h1>
    <h3>- Photos -</h3>
</div>
<div id="content" class="oyf-content">
    <form action="" id="login-form">
        <input type="text" name="username" id="username" class="text-input" placeholder="Username">
        <br><br>
        <input type="password" name="password" id="password" class="text-input" placeholder="Password">
        <br><br>
        <button class="button" onclick="doLogin(event)">Login</button>
    </form>
    <img src="logos/logo512.png">
</div>
<div id="footer" class="oyf-foot">
    <p id="footnavi" class="hidden">
        <span class="fakelink" onclick="getPhotos()">Photos</span> | 
        <span class="fakelink" onclick="showUpload()">Upload</span> | 
        <span class="fakelink" onclick="showCategories()">Categories</span> | 
        <span class="fakelink" onclick="getUserInfo()">Me</span>
    </p>
</div>
</body>
<script>
const baseURL = "http://127.0.0.1:8000";
let cont = document.getElementById('content');

function getInit() {
    let myInit = {
        method: "GET",
        headers: {
            Accept: "application/json",
            Authorization: "Bearer " + sessionStorage.getItem('token'),
        },
        mode: "cors",
        cache: "default",
    };
    return myInit;
}
async function goFetch(request){
    const response = await fetch(request);
    if (response.status === 200) {
        return await response.json();
    }
    else {
        cont.innerHTML += "<div class='error'>Error: Couldn't fetch data. Contact support.</div>";
        return false;
    }
}
async function getUserInfo() {
    const token = sessionStorage.getItem('token');    
    let myInit = getInit();
    const request = new Request(baseURL + "/users/me", myInit);
    res = await goFetch(request);
    if ( res !== false ) {
        //cont.innerHTML = JSON.stringify(res);
        let uinfo = 
            `<form action="" id="user-form">
            <input type="text" name="email" id="email" class="text-input" value="${res.email}"><br><br>
            <button class="button" onclick="UpdateUser(event)">Change</button></form>`;
        cont.innerHTML = uinfo;
    };
}
async function getPhotos() {
    let myInit = getInit();
    const request = new Request(baseURL + "/photos/", myInit);
    res = await goFetch(request);
    if ( res !== false ) {
        cont.innerHTML = "";
        res.forEach((photo) => {
            let click = 'onclick="getPhoto(\'' + photo.id + '\')"';
            let img = "<img src='data:image/jpeg;base64," + photo.thumbnail + "' alt='photo'></img>";
            let span = "<span " + click + " class='thumb'>" + img + "<span/>";
            cont.innerHTML += span;  
        });
    }
}
async function getPhoto(id) {
    const fpath = "/photos/" + id;
    let myInit = getInit();
    const request = new Request(baseURL + fpath, myInit);
    res = await goFetch(request);
    if ( res !== false ) {
        let click = 'onclick="getFullPhoto(\'' + id + '\')"';
        let img = "<img src='data:image/jpeg;base64," + res.image + "' alt='photo'></img>";
        let span = "<span " + click + " class='midpic'>" + img + "<span/>";
        cont.innerHTML = span;
    }
}
async function doLogin(e) {
    e.preventDefault();
    const usern = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    if( usern == "" || password == "" ) {
        cont.innerHTML += "<div class='error'>Enter username and password, please.</div>";
        return null;
    }
    const queryParams = { username: usern, password: password }
    const formbody = new URLSearchParams(queryParams).toString();    
    const request = new Request(baseURL + "/auth/jwt/login", {
        method: "POST",
        mode: "cors", // no-cors, *cors, same-origin
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formbody,
    });
    res = await goFetch(request);
    if ( res !== false ) {
        sessionStorage.setItem('token', res.access_token);
        showNavi();
        getPhotos();
    }
}
async function AddCategory(e) {
    e.preventDefault();
    let cat_title = document.getElementById('title').value;
    if( cat_title == "" ) {
        cont.innerHTML += "<div class='error'>Error! Enter title for new category.</div>";
        return null;
    }    
    let data = JSON.stringify({"title": cat_title});
    const request = new Request(baseURL + "/categories/", {
        method: "POST",
        mode: "cors", // no-cors, *cors, same-origin
        headers: {
            'Accept': 'application/json',
            'Authorization': "Bearer " + sessionStorage.getItem('token'),
            'Content-Type': 'application/json',
        },
        body: data,
    });
    res = await goFetch(request);
    if ( res !== false ) {
        await showCategories();
        cont.innerHTML += '<div class="success">New category added very sucessfully!</div>';
    }
}


function showNavi() {
    document.getElementById("footnavi").classList.remove("hidden");
}
async function showCategories() {
    let myInit = getInit();
    const request = new Request(baseURL + "/categories/", myInit);
    res = await goFetch(request);
    if ( res !== false ) {
        cont.innerHTML = "<h3>Photo categories:</h3>";
        res.forEach((category) => {
            //let click = 'onclick="getPhotos(\'' + category.id + '\')"';
            //let img = "<img src='data:image/jpeg;base64," + photo.thumbnail + "' alt='photo'></img>";
            //let span = "<span " + click + " class='list'>" + category.title + "<span/>";
            let span = "<span class='list'>" + category.title + "<span/><br>";
            cont.innerHTML += span;  
        });
    }

    let form = `<form action="" id="cat-form">
    <input type="text" name="title" id="title" class="text-input" placeholder="New category"><br><br>
    <button class="button" onclick="AddCategory(event)">Add</button></form>`;
    cont.innerHTML += form;
}
function showUpload() {
    let form = `<h3>Upload new photo:</h3><form action="" id="up-form">
    <input type="file" name="upfile" id="upfile" class="text-input" placeholder=""><br><br>
    <button class="button" onclick="doUpload(event)">Send</button></form>`;
    cont.innerHTML = form;
}
async function doUpload(e) {
    e.preventDefault();
    if( document.getElementById("upfile").files.length == 0 ){
       cont.innerHTML += '<div class="error">Select file to upload, pretty please!</div>';
       return false;
    }
    form = new FormData(document.getElementById('up-form'));
    res = await upStuff("/upload/", form);
    console.debug(res);
    await getPhoto(res.id)
    cont.innerHTML += '<div class="success">Photo uploaded very sucessfully!</div>';
}
async function upStuff(fpath, body){
    let request = new Request(baseURL + fpath, {
        method: "POST",
        mode: "cors", // no-cors, *cors, same-origin
        headers: {
            'Accept': 'application/json',
            //'Content-Type': 'multipart/form-data', //i'll remember you, you puny piece of sales
            'Authorization': "Bearer " + sessionStorage.getItem('token'),
        },
        body: body, 
    });
    res = await goFetch(request);
    if ( res !== false ) {
        return res;
    }
}
</script>
</html>