<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Own Your Files â€“ Client</title>
<style>
* { box-sizing: border-box; }
body {
    background-color: #b0aabb;
    margin: 0 auto;
    max-width: 50em;
    font-family: "Helvetica", "Arial", sans-serif;
    font-size: calc(15px + 0.390625vw); /* responsive font size */
    text-align: center;
    min-height: 100vh;
}
h1, h2, h3 { margin: 0; }
.oyf-head, .oyf-foot {color: antiquewhite; height: 3.7em;}
.oyf-content { 
    background-image: linear-gradient(to bottom, #848386, #a09ea5); 
    padding: 0.5em 0;
    min-height: 75vh;
}
.oyf-head {
    background-image: linear-gradient(to bottom, #39383b, #848386);
    border-radius: 5em 5em 0 0;
    overflow: auto;
}
.oyf-head::after {
    content: "";
    display: table;
    clear: both;
    border-bottom: #24202e 2px;
}
.oyf-foot {
    background-image: linear-gradient(to bottom,#848386, #39383b);
    border-radius: 0 0 1.5em 1.5em;
}
.oyf-foot p {margin: 0;padding: 1em 0;}
.oyf-foot a, .oyf-foot .fakelink {color: antiquewhite;}
.oyf-foot .fakelink:hover { color: #24202e; font-weight: bold; cursor: pointer;}
.text-input {
    max-width: 20em;
    border-radius: 4em;
    font-size: 1rem;
    background-color: #b0b5b3;
    padding: 1em 1em;
    margin: 0.5em 0;
    border: none;
}
.text-input::placeholder {color: #6b6969;}
.hidden {display: none;}
.button {
    background-color: #858a88;
    border: 1px solid #2d2b2b;
    border-radius: 4em;
    font-size: 2rem;
    font-weight: bold;
    color: #262525;
    padding: 0.5em 0.8em;
    cursor: pointer;
}
.thumb {padding: 0.5em 0.5em;cursor: pointer;}
.midpic img {cursor: pointer;width: 100%;}
</style>
</head>
<body>
<div class="oyf-head">
    <h1>Own Your Files</h1>
    <h3>- Photos -</h3>
</div>
<div id="content" class="oyf-content">
    <form action="" id="login-form">
        <input type="text" name="username" id="username" class="text-input" placeholder="Username">
        <br><br>
        <input type="password" name="password" id="password" class="text-input" placeholder="Password">
        <br><br>
        <button class="button" onclick=doLogin(event)>Login</button>
    </form>
</div>
<div id="footer" class="oyf-foot">
    <p id="footnavi" class="hidden">
        <span class="fakelink" onclick=getPhotos()>Photos</span> | 
        <span class="fakelink" onclick=showUpload()>Upload</span> |  
        <span class="fakelink" onclick=getUserInfo()>Me</span>
    </p>
</div>
</body>
<script>
const baseURL = "http://127.0.0.1:8000";
function getInit() {
    var myInit = {
        method: "GET",
        headers: {
            Accept: "application/json",
            Authorization: "Bearer " + sessionStorage.getItem('token'),
        },
        mode: "cors",
        cache: "default",
    };
    return myInit;
}
function getStuff(fpath, elem) {
    const token = sessionStorage.getItem('token');    
    var myInit = getInit();
    const request = new Request(baseURL + fpath, myInit);
    fetch(request)
     .then((response) => {
        if (response.status === 200) {
            return response.json();
        }
    })
     .then((response) => {
        var contentElement = document.getElementById(elem);
        contentElement.innerHTML = JSON.stringify(response);
    });
}
function getsPhotos(fpath, elem) {
    var myInit = getInit();
    var request = new Request(baseURL + fpath, myInit);
    fetch(request)
     .then((response) => {
        if (response.status === 200) {
            return response.json();
        }
    })
     .then((response) => {
        var contentElement = document.getElementById(elem);
        contentElement.innerHTML = "";
        response.forEach((photo) => {
            var click = "onclick=getPhoto('"+photo.id+"')";
            var img = "<img src='data:image/jpeg;base64," + photo.thumbnail + "' alt='photo'></img>";
            var span = "<span "+click+" class='thumb'>"+img+"<span/>";
            contentElement.innerHTML += span;  
        });
    });
}
function getsPhoto(id, elem) {
    const fpath = "/photos/" + id;
    var myInit = getInit();
    const request = new Request(baseURL + fpath, myInit);
    fetch(request)
     .then((response) => {
        if (response.status === 200) {
            return response.json();
        }
    })
     .then((response) => {
        var contentElement = document.getElementById(elem);
        var click = "onclick=getFullPhoto('"+id+"')";
        var img = "<img src='data:image/jpeg;base64," + response.image + "' alt='photo'></img>";
        var span = "<span "+click+" class='midpic'>"+img+"<span/>";
        contentElement.innerHTML = span;
    }) 
     .catch((error) => {
        console.error(error);
    });
}
function postStuff(fpath, body){
    const request = new Request(baseURL + fpath, {
        method: "POST",
        mode: "cors", // no-cors, *cors, same-origin
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: body,
    });
    fetch(request)
    .then((response) => {
        if (response.status === 200) {
            return response.json();
        }
    })
    .then((response) => {
        //set token into sessionStorage -> destroyed when client closed
        sessionStorage.setItem('token', response.access_token);
        document.getElementById('content').innerHTML = 'Logged in...';
    });
}
function doLogin(e) {
    e.preventDefault();
    var usern = document.getElementById('username').value;
    var password = document.getElementById('password').value;
    if( usern == "" || password == "" ) {
        alert("Enter username and password, please.");
        return null;
    }
    const queryParams = { username: usern, password: password }
    const formbody = new URLSearchParams(queryParams).toString();    
    postStuff("/auth/jwt/login", formbody);    
    if( sessionStorage.getItem('token') !== null ) {
        showNavi();
        getPhotos();
    }
}
function showNavi() {
    document.getElementById("footnavi").classList.remove("hidden");
}
function getUserInfo() {      
    getStuff("/users/me", 'content');
}
function getPhotos() {
    getsPhotos("/photos/", 'content');    
}
function getPhoto(id) {
    getsPhoto(id, 'content');
}
function showUpload() {
    let form = `<form action="" id="up-form">
    <input type="file" name="upfile" id="upfile" class="text-input" placeholder=""><br><br>
    <button class="button" onclick=doUpload(event)>Send</button></form>`;
    document.getElementById('content').innerHTML = form;
}
function doUpload(e) {
    e.preventDefault();
    form = new FormData(document.getElementById('up-form'))
    upStuff("/upload/", form)
}
function upStuff(fpath, body){
    var token = sessionStorage.getItem('token');
    let request = new Request(baseURL + fpath, {
        method: "POST",
        mode: "cors", // no-cors, *cors, same-origin
        headers: {
            'Accept': 'application/json',
            //'Content-Type': 'multipart/form-data', //i'll remember you, you puny piece of sales
            'Authorization': "Bearer " + token,
        },
        body: body, 
    });
    fetch(request)
    .then((response) => {
        if (response.status === 200) {
            return response.json();
        }
    })
    .then((response) => {
        document.getElementById('content').innerHTML = 'Photo uploaded...';
    });
}    
</script>
</html>